{% extends 'partials/base.html' %} {% load static %} {% block title %} VROOM -
User profile{% endblock %} {% block content %}

<div class="main-container">
  <div class="details">
    <h2>User Profile</h2>
    {% for message in messages %} {% if message.tags == 'error' %}
    <div class="alert alert-danger" role="alert">{{ message }}</div>
    {% elif message.tags == 'success' %}
    <div class="alert alert-success" role="alert">{{ message }}</div>
    {% endif %} {% endfor %}

    <!--buttons in profile page-->
    <button class="button" id="profileBtn">Profile</button>
    <button class="button" id="changePasswordBtn">Change Password</button>
    <button class="button" id="myCarBtn">My Cars</button>
    <button class="button" id="myBookingsBtn">My Bookings</button>

    <!-- My Bookings dropdown -->
    <div id="myBookingsDropdown" style="display: none;">
      <button class="dropdown-btn1" id="pendingBtn">Pending</button>
      <button class="dropdown-btn2" id="approvedBtn">Approved</button>
      <button class="dropdown-btn3" id="completedBtn">Completed</button>
      
    </div>

    <!-- Profile section -->
    <div id="profileSection" class="section">
      <h3>Profile Information</h3>
      <p style="margin-top: 20px; margin-bottom: 10px">
        First Name: <span id="firstName">{{ user.first_name }}</span>
      </p>
      <p style="margin-bottom: 10px">
        Last Name: <span id="lastName">{{ user.last_name }}</span>
      </p>
      <p style="margin-bottom: 10px">
        Username: <span id="username">{{ user.username }}</span>
      </p>
      <p style="margin-bottom: 10px">
        Email: <span id="email">{{ user.email }}</span>
      </p>
      <button class="button" id="editProfileBtn">Edit Profile</button><button id="car-add-btn">Add Car</button>
      <div id="editProfileForm" style="display: none">
        <!-- Edit Profile form -->
        <form
          id="updateProfileForm"
          method="POST"
          action="{% url 'user_profile' %}"
        >
          {% csrf_token %}
          <input type="hidden" name="update_profile" />
          <label for="editFirstName">First Name:</label>
          <input
            type="text"
            id="editFirstName"
            name="first_name"
            value="{{ user.first_name }}"
          /><br />

          <label for="editLastName">Last Name:</label>
          <input
            type="text"
            id="editLastName"
            name="last_name"
            value="{{ user.last_name }}"
          /><br />

          <label for="editUsername">Username:</label>
          <input
            type="text"
            id="editUsername" 
            name="username"
            value="{{ user.username }}"
          /><br />

          <label for="editEmail">Email:</label>
          <input
            type="email"
            id="editEmail"
            name="email"
            value="{{ user.email }}"
          /><br />

          <button class="button" type="submit">Update Profile</button>
        </form>
      </div>
    </div>

    <!-- Change Password section -->
    <div id="changePasswordSection" class="section" style="display: none">
      <h3>Change Password</h3>
      <form
        id="changePasswordForm"
        method="POST"
        action="{% url 'user_profile' %}"
      >
        {% csrf_token %}
        <input type="hidden" name="change_password" />
        <label for="oldPassword">Old Password:</label>
        <input
          type="password"
          id="oldPassword"
          name="old_password"
          required
        /><br />

        <label for="newPassword">New Password:</label>
        <input
          type="password"
          id="newPassword"
          name="new_password1"
          required
        /><br />

        <label for="confirmPassword">Confirm Password:</label>
        <input
          type="password"
          id="confirmPassword"
          name="new_password2"
          required
        /><br />

        <button class="button" type="submit">Update Password</button>
      </form>
    </div>
    
    <!-- popup to add car -->
    <div class="popup" id="addCarPopup">
      <div class="popup-content" >
          <span class="close" id="close" onclick="closePopup('addCarPopup')">&times;</span>
          <h2>Add Car</h2>
          <form id="addCarForm" method="POST" action="{% url 'add_car' %}" enctype="multipart/form-data">
            {% csrf_token %}
              <label for="contactNumber">Contact Number:</label><br>
              <input type="text" id="contactNumber" name="contactNumber"><br>
              <label for="car_type">Car Type:</label><br>
              <input type="text" id="car_type" name="car_type"><br>
              <label for="model">Model:</label><br>
              <input type="text" id="model" name="model"><br>
              <label for="price">Price:</label><br>
              <input type="text" id="price" name="price"><br>
              <label for="carImage">Car Image:</label><br>
              <input type="file" id="carImage" name="carImage"><br><br>
              <button type="submit" id="car_done">Add Car</button>
          </form>
          
      </div>
  </div>

  <!-- My Car section -->
  <div id="myCarSection" class="section" style="display: none;">
    <h3>My Cars</h3>
    {% if cars %}
    <table id="carDetailsTable">
      <thead>
        <tr>
          <th>Renter Name</th>
          <th>Contact Number</th>
          <th>Car Type</th>
          <th>Model</th>
          <th>Price</th>
          <th>Car Image</th>
        </tr>
      </thead>
      <tbody>
        {% for car in cars %}
        <tr>
          <td>{{ car.renter_name }}</td>
          <td>{{ car.renter_contact }}</td>
          <td>{{ car.car_type }}</td>
          <td>{{ car.car_model }}</td>
          <td>{{ car.price }}</td>
          <td>
            {% if car.image %}
              <img src="{{ car.image.url }}" alt="Car Image" style="width: 100px;">
            {% else %}
              No Image Available
            {% endif %}
          </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>You haven't added any cars yet.</p>
    {% endif %}
  </div>

  <!-- My Bookings section -->
  <div id="myBookingsSection" class="section" style="display: none;">
    <h3>My Bookings</h3>
    <table id="bookingDetailsTable">
      <thead>
        <tr>
          <th>Car</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="bookingDetailsBody">
        <!-- Booking details will be dynamically added here -->
      </tbody>
    </table>

    <!-- Payment button -->
    <button id="paymentButton" style="display: none;">Payment</button>

  </div>
  

</div>
<script>
  function closePopup(id) {
      document.getElementById(id).style.display = "none";
    }

  // Adding event listeners for buttons
  document.addEventListener("DOMContentLoaded", function () {
    var editProfileBtn = document.getElementById("editProfileBtn");
    var editProfileForm = document.getElementById("editProfileForm");
    var changePasswordBtn = document.getElementById("changePasswordBtn");
    var changePasswordSection = document.getElementById("changePasswordSection");
    var profileSection = document.getElementById("profileSection");
    var profileBtn = document.getElementById("profileBtn");
    var addCar = document.getElementById("addCarPopup");
    var addBtn = document.getElementById("car-add-btn");
    var myCarBtn = document.getElementById("myCarBtn");
    var myCarSection = document.getElementById("myCarSection");
    var myBookingsBtn = document.getElementById("myBookingsBtn");
    var myBookingsDropdown = document.getElementById("myBookingsDropdown");
    var pendingBtn = document.getElementById("pendingBtn");
    var approvedBtn = document.getElementById("approvedBtn");
    var paymentBtn = document.getElementById("paymentBtn");
    var completedBtn = document.getElementById("completedBtn");

    profileBtn.addEventListener("click", function () {
      editProfileForm.style.display = "none";
      changePasswordSection.style.display = "none";
      profileSection.style.display = "block";
      addCar.style.display = "none";
      myCarSection.style.display = "none";
      myBookingsDropdown.style.display = "none";
      myBookingsSection.style.display = "none";
    });

    editProfileBtn.addEventListener("click", function () {
      editProfileForm.style.display = "block";
      changePasswordSection.style.display = "none";
      profileSection.style.display = "block";
      addCar.style.display = "none";
      myCarSection.style.display = "none";
      myBookingsDropdown.style.display = "none";
      myBookingsSection.style.display = "none";
    });

    changePasswordBtn.addEventListener("click", function () {
      editProfileForm.style.display = "none";
      changePasswordSection.style.display = "block";
      profileSection.style.display = "none";
      addCar.style.display = "none";
      myCarSection.style.display = "none";
      myBookingsDropdown.style.display = "none";
      myBookingsSection.style.display = "none";
    });

    addBtn.addEventListener("click", function () {
      editProfileForm.style.display = "none";
      changePasswordSection.style.display = "none";
      profileSection.style.display = "block";
      addCar.style.display = "block";
      myCarSection.style.display = "none";
      myBookingsDropdown.style.display = "none";
    });

    function validateAddCarForm() {
      var contactNumber = document.getElementById("contactNumber").value;
      var carType = document.getElementById("car_type").value;
      var model = document.getElementById("model").value;
      var price = document.getElementById("price").value;
      var carImage = document.getElementById("carImage").value;

      if (!contactNumber || !carType || !model || !price || !carImage) {
        alert("Please fill in all fields, including the car image.");
        return false;
      }

      if (!/^\d{10}$/.test(contactNumber)) {
        alert("Contact number must be a 10-digit number.");
        return false;
      }

      return true;
    }

    var addCarForm = document.getElementById("addCarForm");
    addCarForm.addEventListener("submit", function (event) {
      if (!validateAddCarForm()) {
        event.preventDefault(); // Prevent form submission if validation fails
      }
    });
    
    myCarBtn.addEventListener("click", function () {
      // Handle My Car button click
      editProfileForm.style.display = "none";
      changePasswordSection.style.display = "none";
      profileSection.style.display = "none";
      addCar.style.display = "none";
      myCarSection.style.display = "block";
      myBookingsSection.style.display = "none";
      myBookingsDropdown.style.display = "none";
    });

    // Define the displayBookings function outside of the event listener
    function displayBookings(bookings) { 
      const tbody = document.getElementById("bookingDetailsBody");
      tbody.innerHTML = ""; // Clear existing rows

      bookings.forEach(booking => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${booking.car}</td>
          <td>${booking.start_date}</td>
          <td>${booking.end_date}</td>
          <td>${booking.status}</td>
    `    ;
        tbody.appendChild(row);
      });
    }

    // Event listener for My Bookings button
    myBookingsBtn.addEventListener("click", function () {
      // Toggle the display of the dropdown menu
      if (myBookingsDropdown.style.display === "none") {
        myBookingsDropdown.style.display = "block";
      } else {
        myBookingsDropdown.style.display = "none";
      }

      // Hide all other sections
      editProfileForm.style.display = "none";
      changePasswordSection.style.display = "none";
      profileSection.style.display = "none";
      addCar.style.display = "none";
      myCarSection.style.display = "none";

      // Sample data for bookings (simulating backend response)
      const bookingsData = {
        pending: [
        { car: "Toyota Camry", start_date: "2024-05-15", end_date: "2024-05-20", status: "Pending" },
        { car: "Honda Civic", start_date: "2024-05-18", end_date: "2024-05-25", status: "Pending" }
      ],
      approved: [
        { car: "BMW X5", start_date: "2024-05-22", end_date: "2024-05-28", status: "Approved" }
      ],
      completed: [
        { car: "Tesla Model 3", start_date: "2024-05-10", end_date: "2024-05-15", status: "Completed" }
      ]
    };

    // Event listener for dropdown buttons
    pendingBtn.addEventListener("click", function () {
      // Call displayBookings function with pending bookings data
      displayBookings(bookingsData.pending);

      // Show the My Bookings section
      document.getElementById("myBookingsSection").style.display = "block";

      // Hide payment button
      document.getElementById("paymentButton").style.display = "none";

    });
    
    // Event listener for dropdown buttons
    approvedBtn.addEventListener("click", function () {
      // Call displayBookings function with approved bookings data
      displayBookings(bookingsData.approved);
      
      // Show the My Bookings section
      document.getElementById("myBookingsSection").style.display = "block";

      // Show the Payment button only if there are approved bookings
      if (bookingsData.approved.length > 0) {
        document.getElementById("paymentButton").style.display = "block";
      } else {
        document.getElementById("paymentButton").style.display = "none";
      }
    });

    // Event listener for Payment button
    paymentButton.addEventListener("click", function () {
      // Redirect to the payment page
      window.location.href = "payment_view/";
    });

    completedBtn.addEventListener("click", function () {
      // Call displayBookings function with completed bookings data
      displayBookings(bookingsData.completed);

      // Show the My Bookings section
      document.getElementById("myBookingsSection").style.display = "block";

      // Hide payment button
      document.getElementById("paymentButton").style.display = "none";
   });
  });
});

</script>

<style>
  :root {
    --indigo: #16425b;
    --lapis: #2f6690;
    --cerulean: #3a7ca5;
    --skyblue: #81c3d7;
    --platinum: #d9dcd6;
    --darkgray: #b4b4b3;
    --red: #f44336;
    --green: #4CAF50;
    --darkgreen: darkgreen;
    --crimson: crimson;
    --white:#ffffff;
}

  body {
    font-family: "Montserrat", sans-serif;
  }

  .main-container {
    width: 90vw;
    margin: 0 5%;
    margin-top: 9.8vh;
    min-height: 65.6vh;
  }

  .details {
    padding: 40px;
  }

  h2,
  h3 {
    color: var(--indigo);
  }

  .button {
    padding: 8px 16px;
    border: none;
    background-color: var(--lapis);
    color: var(--platinum);
    cursor: pointer;
    border-radius: 5px;
    margin-right: 10px;
    font-size: medium;
    margin-top: 20px;
  }

  .button:hover {
    background-color: var(--indigo);
  }

  .section {
    margin-top: 20px;
  }

  form {
    margin-top: 10px;
  }

  form label {
    display: block;
    margin-bottom: 5px;
  }

  form input {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
  }

  form button {
    padding: 8px 20px;
    background-color: var(--indigo);
    color: var(--white);
    border: none;
    cursor: pointer;
  }

  form button:hover {
    background-color: var(--lapis);
  }

  /* Customizing alert colors */
  .alert-danger {
    color: var(--red);
    font-weight: bold;
  }

  .alert-success {
    color: var(--green);
    font-weight: bold;
  }

  /* Adjusting message display */
  .message {
    margin-top: 20px;
    max-width: 300px;
    word-wrap: break-word; /* Allow long messages to wrap */
  }

  #addCarPopup{
    display: none;
  }

  #close{
    float: right;
    font-size: 30px;
    cursor: pointer;
  }

  #car-add-btn {
    margin-top: 2vh;
    background-color: var(--lapis);
    padding: 8px 27px;
    border: none;
    color: var(--white);
    cursor: pointer;
    border-radius: 5px;
    margin: 10px 0px 10px;
    font-size: medium;
  }

  #car_done{
    margin-top: 2vh;
    background-color: var(--green);
    padding: 8px 27px;
    border: none;
    color: var(--white);
    cursor: pointer;
    border-radius: 5px;
    margin: 10px 0px 10px;
    font-size: medium;
  }

  #car_done:hover {
      background-color: var(--darkgreen);
  }

  /* CSS for table */
  #carDetailsTable {
    width: 100%;
    border-collapse: collapse;
  }

  #carDetailsTable th,
  #carDetailsTable td {
    border: 1px solid #dddddd;
    padding: 8px;
    text-align: left;
  }

  #carDetailsTable th {
    background-color: #f2f2f2;
  }

  #myCarSection {
    margin-top: 30px;
  }

  #carDetailsTable{
    margin-top: 15px;
  }

  #bookingDetailsTable {
    width: 100%;
    border-collapse: collapse;
  }

  #bookingDetailsTable th,
  #bookingDetailsTable td {
    border: 1px solid #dddddd;
    padding: 8px;
    text-align: left;
  }

  #bookingDetailsTable th {
    background-color: #f2f2f2;
  }

  #myBookingsSection {
    margin-top: 30px;
  }

  #bookingDetailsTable{
    margin-top: 15px;
  }

  #myBookingsDropdown {
    margin-top: 30px; 
  }

/* CSS for dropdown buttons */
.dropdown-btn1,
.dropdown-btn2,
.dropdown-btn3 {
  padding: 11px 22px; /* Increasing padding to make the buttons wider */
  margin-right: 15px; /* Adjusting margin to provide spacing between buttons */
  border: 1px solid var(--indigo); /* Adding border for better visibility */
  background-color: var(--platinum); /* Changing background color */
  color: var(--indigo); /* Changing text color */
  cursor: pointer;
  border-radius: 4px;
  transition: background-color 0.3s ease;
}

/* Hover effect */
.dropdown-btn1:hover,
.dropdown-btn2:hover,
.dropdown-btn3:hover {
  background-color: var(--indigo);
  color: var(--platinum);
}

/* Active state */
.dropdown-btn1:active,
.dropdown-btn2:active,
.dropdown-btn3:active {
  background-color: var(--lapis);
}

/* CSS for payment button */
#paymentButton {
  padding: 11px 22px; /* Increasing padding to make the buttons wider */
  margin-right: 15px; /* Adjusting margin to provide spacing between buttons */
  border: 1px solid var(--indigo); /* Adding border for better visibility */
  background-color: var(--platinum); /* Changing background color */
  color: var(--indigo); /* Changing text color */
  cursor: pointer;
  border-radius: 4px;
  transition: background-color 0.3s ease;
  margin-top:25px;
}

/* Hover effect */
#paymentButton {
  background-color: var(--indigo);
  color: var(--platinum);
}

/* Active state */
#paymentButton:active {
  background-color: var(--lapis);
}
</style>
{% endblock %}
